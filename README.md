# Кастомный токен и Scroll мост L1/L2

Этот проект демонстрирует создание кастомных токенов и мостов для их передачи между Ethereum (L1) и Scroll (L2).

# Если хотите посмотреть как это все работает, контракты в тестовых сетях и веб-интерфейс: 

## Мост для токенов:
- Токен в ethereum: [0x728855754f79f4Ec7e5A97878b195Ac06D970aB0](https://sepolia.etherscan.io/address/0x728855754f79f4Ec7e5A97878b195Ac06D970aB0)
- Мост в ethereum: [0x890309B7c5BE9E008385d422E9893f3279383a17](https://sepolia.etherscan.io/address/0x890309B7c5BE9E008385d422E9893f3279383a17)
- Токен в Scroll: [0x890309B7c5BE9E008385d422E9893f3279383a17](https://sepolia.scrollscan.com/address/0x890309B7c5BE9E008385d422E9893f3279383a17)
- Мост в Scroll: [0x728855754f79f4Ec7e5A97878b195Ac06D970aB0](https://sepolia.scrollscan.com/address/0x728855754f79f4Ec7e5A97878b195Ac06D970aB0)

## Мост для ETH:
- Мост в ethereum (L1LockBridge): [0xBdc08074e5797df283d2212A0088f37d22eC6b41](https://sepolia.etherscan.io/address/0xBdc08074e5797df283d2212A0088f37d22eC6b41)
- Мост в Scroll (L2LockBridge): [0x2c51eaEf3e08F8b7f74D802C65B2b45f775351E1](https://sepolia.scrollscan.com/address/0x2c51eaEf3e08F8b7f74D802C65B2b45f775351E1)

## Дополнительные сервисы
- Аккаунт релеера: [0xd134B798469439A60B5868076d3DC6A94D9d8b76](https://sepolia.etherscan.io/address/0xd134B798469439A60B5868076d3DC6A94D9d8b76)
- [Веб-интерфейс для перевода](https://scrollethbridge.duckdns.org/)
- Telegram бот (beta): [@scroll_eth_bridge_bot](https://t.me/scroll_eth_bridge_bot)

## Новые функции
- Автоматический релеер для клейма токенов и ETH
- Telegram бот для удобного перевода токенов (в бете)
- Веб-интерфейс с поддержкой MetaMask и улучшенным UX
- Поддержка как токенов, так и ETH в мосте с автоматическим расчетом комиссий
- Планируется кран токенов для тестов
- Новая система комиссий для моста эфира с прозрачным расчетом затрат на газ (комиссии для моста токенов нет)

## Содержание

- [Установка](#установка)
- [Конфигурация](#конфигурация)
- [Использование](#использование)
  - [Деплой контрактов](#деплой-контрактов)
  - [Верификация контрактов](#верификация-контрактов)
  - [Перевод токенов с L1 на L2](#перевод-токенов-с-l1-на-l2)
  - [Перевод токенов с L2 на L1](#перевод-токенов-с-l2-на-l1)
  - [Клейм токенов с L2 на L1](#клейм-токенов-с-l2-на-l1)
- [Принцип работы](#принцип-работы)
  - [Архитектура моста](#архитектура-моста)
  - [Передача сообщений](#передача-сообщений)
  - [Процесс клейма](#процесс-клейма)
  - [Газовые комиссии](#газовые-комиссии)

## Установка

1. Клонирование репозитория:
   ```bash
   git clone <url-репозитория>
   cd <директория-проекта>
   ```

2. Установка зависимостей:
   ```bash
   npm install
   ```

3. Убедитесь, что у вас настроен доступ к тестовым сетям Scroll:
   - L1 сеть: Sepolia (https://ethereum-sepolia-rpc.publicnode.com)
   - L2 сеть: Scroll Sepolia (https://scroll-sepolia-rpc.publicnode.com)

## Конфигурация

Проект использует Hardhat для деплоя контрактов и выполнения скриптов. Конфигурация находится в `hardhat.config.js`.

Основные файлы:
- `contracts/` - смарт-контракты (токены L1/L2 и мосты)
- `scripts/` - скрипты для деплоя и верификации контрактов
- `user_scripts/` - скрипты для взаимодействия с мостом (перевод и клейм токенов)
- `frontend/` - веб-интерфейс для взаимодействия с мостом
- `relayer/` - сервис для автоматического клейма токенов
- `bridge_bot/` - Telegram бот для взаимодействия с мостом
- `addresses.json` - адреса задеплоенных контрактов

## Использование

### Деплой контрактов

Для деплоя всех необходимых контрактов выполните:

```bash
npm run deploy
```

Этот скрипт выполнит следующие действия:
1. Деплой L1CustomToken на L1
2. Деплой L1TokenBridge на L1
3. Деплой L2TokenBridge на L2
4. Деплой L2CustomToken на L2
5. Инициализацию обоих мостов
6. Сохранение адресов контрактов в `addresses.json`

### Верификация контрактов

Для верификации контрактов на Etherscan и Scrollscan:

```bash
npm run verify
```

Этот скрипт автоматически верифицирует все контракты (и на L1, и на L2) с помощью API соответствующих сканеров.

### Общий скрит для взаимодействи

```bash
npm run bridge
```
Скрипт предлагает выбрать и автоматически запускает скрипты описанные ниже

### Перевод токенов с L1 на L2

```bash
npm run bridgel1tol2
```

Этот скрипт:
1. Запрашивает ваш приватный ключ
2. Проверяет наличие токенов на L1
3. Одобряет мост на использование токенов
4. Отправляет токены через мост на L2
5. Выводит хэш транзакции

### Перевод токенов с L2 на L1

```bash
npm run bridgel2tol1
```

Этот скрипт:
1. Запрашивает ваш приватный ключ
2. Проверяет наличие токенов на L2
3. Рассчитывает газовую комиссию для выполнения транзакции на L1
4. Отправляет токены через мост на L1
5. Выводит хэш транзакции и ID сообщения для последующего клейма

### Клейм токенов с L2 на L1

После отправки токенов с L2 на L1 необходимо выполнить процедуру клейма для получения токенов на L1:

```bash
npm run claiml2tol1
```

Этот скрипт:
1. Запрашивает хэш транзакции перевода с L2 на L1
2. Получает доказательство через API Scroll
3. Выполняет клейм токенов на L1

```bash
bridgeethl1tol2
```
Этот скрипт:
1. Запрашивает ваш приватный ключ
2. Проверяет наличие эфира на L1
3. Одобряет мост на использование токенов
4. Отправляет эфир через мост на L2
5. Выводит хэш транзакции

```bash
bridgeethl2tol1
```
Этот скрипт:
1. Запрашивает ваш приватный ключ
2. Проверяет наличие эфира на L2
3. Рассчитывает газовую комиссию для выполнения транзакции на L1
4. Отправляет эфир через мост на L1
5. Выводит хэш транзакции 

```bash
claimethL2tol1
```
1. Запрашивает хэш транзакции перевода с L2 на L1
2. Получает доказательство через API Scroll
3. Выполняет клейм эфира на L1

## Принцип работы

### Архитектура моста

Система теперь состоит из шести основных компонентов:
1. **L1CustomToken** - ERC20 токен на Ethereum (L1)
2. **L2CustomToken** - ERC20 токен на Scroll (L2)
3. **L1TokenBridge** - мост на L1 для токенов
4. **L2TokenBridge** - мост на L2 для токенов
5. **L1LockBridge** - мост на L1 для ETH
6. **L2LockBridge** - мост на L2 для ETH

Мосты для ETH используют механизм блокировки (lock/unlock):
- При переводе ETH с L1 на L2, ETH блокируется в L1LockBridge
- При переводе ETH с L2 на L1, пользователь отправляет ETH в L2LockBridge
- Релеер автоматически выполняет клейм для обоих типов активов

Комиссии и газ для моста токенов:
-только комиссии сети 

Комиссии и газ для моста эфира:
- Все мосты используют единую систему расчета комиссий
- Комиссии включают фиксированную часть, процент от суммы и компенсацию газа
- Наценка в 10% на газ защищает от колебаний цен на газ
- Владелец контракта может настраивать параметры комиссий

### Передача сообщений

#### L1 → L2 (Депозит):
1. Пользователь вызывает `bridgeToken` на L1TokenBridge, передавая ETH для оплаты газа на L2
2. L1TokenBridge переводит токены с кошелька пользователя на себя (lock)
3. L1TokenBridge формирует сообщение с вызовом `finalizeDepositERC20` и отправляет его через L1ScrollMessenger
4. Сообщение попадает в L1MessageQueue
5. Релеер Scroll обнаруживает сообщение и отправляет его на L2
6. На L2 вызывается L2TokenBridge.finalizeDepositERC20, который минтит токены получателю

#### L2 → L1 (Вывод):
1. Пользователь вызывает `bridgeToken` на L2TokenBridge, передавая ETH для оплаты газа на L1
2. L2TokenBridge сжигает токены пользователя (burn)
3. L2TokenBridge формирует сообщение с вызовом `finalizeWithdrawERC20` и отправляет его через L2ScrollMessenger
4. Сообщение записывается в L2MessageQueue в бинарное дерево Меркла (withdraw tree)
5. Для завершения процесса требуется клейм на L1

### Процесс клейма

После отправки токенов с L2 на L1 требуется дополнительный шаг - клейм:

1. Пользователь получает доказательство Меркла через API Bridge History
2. Пользователь вызывает `relayMessageWithProof` на L1ScrollMessenger, передавая:
   - Адрес отправителя сообщения (L2TokenBridge)
   - Адрес получателя (L1TokenBridge)
   - Значение (обычно 0)
   - Nonce сообщения
   - Данные сообщения (закодированный вызов finalizeWithdrawERC20)
   - Доказательство (batchIndex и merkleProof)
3. L1ScrollMessenger проверяет доказательство и вызывает finalizeWithdrawERC20 на L1TokenBridge
4. L1TokenBridge разблокирует и переводит токены пользователю

### Газовые комиссии

#### L1 → L2:
- Для токенов и ETH требуется передать ETH вместе с транзакцией для оплаты газа на L2
- Комиссия состоит из трех компонентов:
  1. Фиксированная комиссия (0.001 ETH)
  2. Процентная комиссия (0.1% от суммы перевода)
  3. Компенсация газа с наценкой 10% для покрытия колебаний
- Неиспользованный ETH для газа возвращается отправителю
- Расчет комиссии производится автоматически смарт-контрактом

#### L2 → L1:
- Требуется передать ETH вместе с транзакцией для оплаты газа на L1
- Комиссия рассчитывается аналогично L1 → L2:
  1. Фиксированная комиссия (0.001 ETH)
  2. Процентная комиссия (0.1% от суммы)
  3. Компенсация L1 газа с 10% наценкой
- Для стандартных операций обычно достаточно 0.05 ETH (зависит от загрузки L1)

При клейме токенов или ETH с L2 на L1 также требуется оплатить газ за выполнение транзакции клейма на L1.

### Веб-интерфейс

Обновленный веб-интерфейс доступен по адресу [https://scrollethbridge.duckdns.org/](https://scrollethbridge.duckdns.org/)

Новые функции:
- Улучшенный UX с пошаговыми инструкциями
- Автоматический расчет комиссий и необходимого газа
- Поддержка как токенов, так и ETH
- Отслеживание статуса транзакций в реальном времени
- История транзакций с возможностью повтора
- Интеграция с релеером для автоматического клейма
- Мультиязычный интерфейс (EN/RU)

Для локального запуска:
1. Убедитесь, что все контракты задеплоены и верифицированы
2. Настройте в файле `app.js` адреса ваших контрактов
3. Запустите локальный веб-сервер:
   ```bash
   cd frontend
   python -m http.server 8000
   ```
4. Откройте в браузере адрес: http://localhost:8000

### Telegram Бот

В проекте реализован Telegram бот для удобного взаимодействия с мостом через мессенджер: [@scroll_eth_bridge_bot](https://t.me/scroll_eth_bridge_bot)

Основные команды:
- `/start` - начало работы и информация о боте
- `/balance` - проверка баланса на L1 и L2
- `/bridge` - перевод токенов между сетями
- `/claim` - клейм токенов с L2 на L1
- `/help` - справка по командам

Для запуска собственного бота:
1. Создайте бота через @BotFather и получите токен
2. Настройте конфигурацию в `bridge_bot/.env`
3. Установите зависимости и запустите:
   ```bash
   cd bridge_bot
   pip install -r requirements.txt
   ./start_bot.sh
   ```

### Релейер

Для автоматизации процесса клейма токенов реализован релейер. Он отслеживает новые транзакции и автоматически выполняет клейм.

Основные функции:
- Мониторинг новых транзакций в мосте
- Автоматическое получение доказательств
- Выполнение клейма токенов и ETH
- Ведение логов и статистики

Настройка:
1. Создайте файл `relayer/.env` на основе `.env.example`
2. Укажите приватный ключ и настройки RPC
3. Запустите релейер:
   ```bash
   cd relayer
   pip install -r requirements.txt
   ./start_relayer.sh
   ``` 
